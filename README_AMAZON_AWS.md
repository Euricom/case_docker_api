# Deploying this example application to Amazon AWS (Elastic Beanstalk)

This guide will help you deploy a Docker application to AWS Elastic Beanstalk.
We will use 

**CircleCI** for continous integration

**Amazon Elastic Beanstalk** as a service to help you deploy your Docker application easily 

Elastic Beanstalk makes it very easy to deploy your application to Amazon. 

## Assumptions

### CircleCI

You have added this project in CircleCI.

### Environments
I assume you want 3 environments for your application : development, staging and production 
              and you have 2 (git) branches: **develop** and **master** (of course branch names can differ a bit)

### Branches
Develop is your development branch. (= development environment).

Master branch represents a working/production ready state of your code. 

### Docker images storage
Docker images need to be stored somewhere (Docker Hub, Amazon Container Service, etc ...) before they can be deployed to Elastic Beanstalk. I chose Amazon Container Service.
If you want to use another registry you will have to edit the shell script a bit.

### Versioning
All docker images are stored on Amazon. For development we do not store multiple docker image versions. So it will replace the docker image with tag 'dev' every time.
For staging: we give the tag a build number generated by CircleCI.

### Deploying to production
To deploy to production you want to use the ElasticBeanstalk web interface to deploy a specific version (choose a version that is ready and tested).
It is very easy to deploy different application versions to whatever environment you want. 

### Application name is the same in Elastic Beanstalk as your docker repository name
My script assumes both are the same. But nothing stops you from editing the script.

## What does the script do ?
Whenever you commit on develop/master branch, CircleCI should trigger a build. Then it will run this script
**deploy_aws_elasticbeanstalk.sh** with parameter **'dev'** or **'staging**'.

The script contains a simple Mocha test. If the test passes, it will

1) Login to AWS, 
2) Build a docker image of your current build, 
3) Store this docker image,
4) Deploy to the correct ElasticBeanstalk environment.
     For Dev: it will create a version label: development_GITHASH. This makes it very easy to see which version is currently on dev environment (you see this in the web interface of ElasticBeanstalk).
            We do not store multiple versions of dev because it isn't necessary.
     For staging: it will create a version label which is the current version of package.json

## Preparation AWS

1. Create a S3 Bucket. 

## Preparation

1. Make sure you have your Docker working and you can launch the example app on your machine in Docker.

2. Install AWS CLI. See [Installing the AWS Command Line Interface](http://docs.aws.amazon.com/cli/latest/userguide/installing.html)

   *Note: this might not be required because CircleCI has AWS CLI installed and the script will be started from CircleCI.
   But it is very useful to have when you have problems and want to test it from your machine
   But. You will need it if you want your ElasticBeanstalk to load a docker image from a private docker repository*

3. Try to login to AWS with your AWS CLI. Open a cmd and type in 
    `aws ecr get-login`. Now copy paste the output and execute it (it is a docker login command with a long secret key:  `docker login -u AWS -p xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -e none https://amazonaws...`).
    Make sure Login succeeds.

## Configuration

1. Under deploy\aws_dev edit Dockerrun.aws.json so that "Bucket" and "Key" are your bucket name and use config.json as "Key". 

2. Under deploy\aws_staging edit Dockerrun.aws.json so that "Bucket" and "Key" are your bucket name and use config.json as "Key".

3. **Necessary only if you use AWS Container Service for storing private Docker images** 
    You will need to edit the config.json file. Under 'preparation' folder you will find an empty config.json. We will store this file in a next step in S3 because ElasticBeanstalk must be able to get this config file and be able to authenticate.
        Edit the config.json file so that auth and email are filled in. 
        **auth**: You can find your auth secret under your .docker folder (mine was located at C:\Users\Wim\.docker). I use Windows machine. 
                   You need to have logged in successfully or you won't find a key here.
        **email** Your email for logging in to AWS Console.

4. Go to EC2 Container Service. Under repositories create a repository to hold your docker images.

5. Go to S3 and upload the edited config.json file to your bucket.

6. Create a new Application in Elastic Beanstalk. You want to create 3 environments. I named them caseDockerApi-dev, caseDockerApi-staging and caseDockerApi-production.
   For each environment:
   - You need to choose an environment tier: choose Web server environment.
   - Choose Docker as Platform
   - Upload your code: upload the Dockerrun.aws.json
   - Enter the name for your environment

   The app will not work yet as the docker image is not uploaded yet in your EC2 Container Service repository. But this should be fixed when the script is executed.
   
7. Edit deploy/aws_dev/Dockerrun.aws.json
     `708547824206.dkr.ecr.us-west-2.amazonaws.com/case-docker-api:dev` with your repository name (which you can find in your EC2 Container Service repositories). Don't forget that it should still end with `:dev`

8. Edit deploy/aws_dev/Dockerrun.aws.json
     `708547824206.dkr.ecr.us-west-2.amazonaws.com/case-docker-api:latest` with your repository name (which you can find in your EC2 Container Service repositories). Don't forget that it should still end with `:latest`

9. Add environment variable to CircleCI. 
    1. AWS_ACCOUNT_ID with your AWS account id

10. Edit `circle.yml`:
        1. Replace parameters for `deploy_aws_elasticbeanstalk.sh`
            First parameter should be the ending of the environment name in Elastic Beanstalk
            Second parameter is your application name in Elastic Beanstalk
            Third parameter is your bucket name
            Fourth parameter is the region (it is important!)

        *Note: You can also use environment variables in CircleCI instead of passing these hardcoded in circle.yml.* 


11. Add permissions/roles so ElasticBeanstalk

## Let CircleCI do it's job

Now if you commit to develop branch or master branch, it should automatically deploy your app to Amazon.
